<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentication Features Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/auth-styles.css">
  <link rel="stylesheet" href="assets/css/enhanced-auth-buttons.css">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="container mt-5">
        <h1>EDJS Authentication System Test</h1>
        
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Authentication Status</h5>
                    </div>
                    <div class="card-body">
                        <div id="authStatus">Loading...</div>
                        <button class="btn btn-primary mt-2" onclick="testAuth()">Test Auth System</button>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Feature Tests</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-success mb-2 w-100" onclick="testLoginModal()">Test Login Modal</button>
                        <button class="btn btn-info mb-2 w-100" onclick="testRegisterModal()">Test Register Modal</button>
                        <button class="btn btn-warning mb-2 w-100" onclick="testGuestPopup()">Test Guest Popup</button>
                        <button class="btn btn-secondary mb-2 w-100" onclick="testUserMenu()">Test User Menu</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Integration Check</h5>
                    </div>
                    <div class="card-body">
                        <div id="integrationStatus">Checking...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/supabase-config.js"></script>
    <script src="assets/js/spectacles-auth.js"></script>
    
    <script>
        function updateAuthStatus() {
            const statusDiv = document.getElementById('authStatus');
            if (window.authManager) {
                statusDiv.innerHTML = `
                    <p><strong>Auth Manager:</strong> ✅ Loaded</p>
                    <p><strong>Current User:</strong> ${window.authManager.currentUser ? window.authManager.currentUser.email : 'None'}</p>
                    <p><strong>User Role:</strong> ${window.authManager.userRole || 'None'}</p>
                    <p><strong>Is Guest:</strong> ${window.authManager.isGuest ? 'Yes' : 'No'}</p>
                `;
            } else {
                statusDiv.innerHTML = '<p><strong>Auth Manager:</strong> ❌ Not loaded (still loading...)</p>';
            }
        }

        function checkIntegration() {
            const integrationDiv = document.getElementById('integrationStatus');
            let status = [];
            
            // Check Supabase
            if (typeof supabase !== 'undefined') {
                status.push('✅ Supabase Client loaded');
                try {
                    // Test Supabase connection
                    supabase.auth.getSession().then(() => {
                        status.push('✅ Supabase connection working');
                    }).catch(err => {
                        status.push('⚠️ Supabase connection error: ' + err.message);
                    });
                } catch (e) {
                    status.push('⚠️ Supabase error: ' + e.message);
                }
            } else {
                status.push('❌ Supabase Client missing');
            }
            
            // Check Auth Manager
            if (window.authManager) {
                status.push('✅ Auth Manager initialized');
            } else {
                status.push('❌ Auth Manager not initialized');
            }
            
            // Check Header Container
            const authContainer = document.querySelector('.vs-header__action .d-none.d-xxl-inline-flex');
            if (authContainer) {
                status.push('✅ Header auth container found');
                if (authContainer.children.length > 0) {
                    status.push('✅ Auth buttons rendered');
                } else {
                    status.push('⚠️ Auth container empty');
                }
            } else {
                status.push('❌ Header auth container missing');
            }
            
            integrationDiv.innerHTML = status.map(s => `<p>${s}</p>`).join('');
        }

        function testAuth() {
            updateAuthStatus();
        }

        function testLoginModal() {
            if (typeof authManager !== 'undefined') {
                authManager.showAuthModal('login');
            } else {
                alert('Auth Manager not loaded');
            }
        }

        function testRegisterModal() {
            if (typeof authManager !== 'undefined') {
                authManager.showAuthModal('register');
            } else {
                alert('Auth Manager not loaded');
            }
        }

        function testGuestPopup() {
            if (typeof authManager !== 'undefined') {
                authManager.showGuestAccessPopup();
            } else {
                alert('Auth Manager not loaded');
            }
        }

        function testUserMenu() {
            // Simulate logged in state for testing
            if (typeof authManager !== 'undefined') {
                authManager.currentUser = { id: 'test-user', email: 'test@example.com' };
                authManager.userRole = 'individual';
                authManager.updateUI();
                alert('User menu should now appear in header (if header is present)');
            } else {
                alert('Auth Manager not loaded');
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                updateAuthStatus();
                checkIntegration();
            }, 2000);
        });
        
        // Also try to initialize after all scripts load
        window.addEventListener('load', function() {
            setTimeout(() => {
                updateAuthStatus();
                checkIntegration();
            }, 1000);
        });
    </script>
</body>
</html>
